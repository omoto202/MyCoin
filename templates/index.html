<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyCoin Wallet (localStorage)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.6.1/elliptic.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
input { padding: 6px; margin: 6px 0; width: 320px; }
button { padding: 6px 10px; margin: 4px; }
textarea { width: 100%; }
.block { background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
#history { white-space: pre-wrap; background:#f9f9f9; padding:8px; border-radius:4px; max-height: 400px; overflow:auto; }
.status { margin-top:8px; color:#333; }
</style>
</head>
<body>
<h1>MyCoin Wallet (localStorage)</h1>

<div class="block">
  <h2>éµç®¡ç†</h2>
  <button id="genBtn">éµãƒšã‚¢ç”Ÿæˆ</button>
  <button id="resetBtn">éµãƒšã‚¢ãƒªã‚»ãƒƒãƒˆ</button>
  <div id="keys">éµãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div class="block">
  <h2>é€é‡‘</h2>
  <form id="txForm">
    <input name="recipient" placeholder="å—ä¿¡è€…ã®å…¬é–‹éµ" required><br>
    <input name="amount" placeholder="é‡‘é¡" required><br>
    <button type="submit">é€ä¿¡</button>
  </form>
  <div id="txResult" class="status"></div>
</div>

<div class="block">
  <h2>æ®‹é«˜ç¢ºèª</h2>
  <form id="balanceForm">
    <input name="address" placeholder="ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ï¼ˆç©ºã§è‡ªåˆ†ã®å…¬é–‹éµï¼‰"><br>
    <button type="submit">æ®‹é«˜å–å¾—</button>
  </form>
  <div id="balance">æ®‹é«˜: -</div>
</div>

<div class="block">
  <h2>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³</h2>
  <button id="loadChainBtn">å±¥æ­´ã‚’è¡¨ç¤º</button>
  <button id="clearLocalChainBtn">ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒ¼ãƒ³å‰Šé™¤</button>
  <div id="history"></div>
  <div id="chainStatus" class="status"></div>
</div>

<div class="block">
  <h2>ãƒã‚¤ãƒ‹ãƒ³ã‚°</h2>
  <button id="mineBtn">ãƒã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹</button>
  <div id="mineStatus" class="status"></div>
</div>

<script>
/* --------- åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— --------- */
const ec = new elliptic.ec('secp256k1');
const socket = io();

/* LocalStorage ã®ã‚­ãƒ¼ */
const LS_CHAIN_KEY = 'mycoin_chain_v1';

/* æ—¢å­˜ã®éµç®¡ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰ */
function saveKeys(pub, priv) {
  localStorage.setItem('publicKey', pub);
  localStorage.setItem('privateKey', priv);
}
function loadKeys() {
  return {
    publicKey: localStorage.getItem('publicKey'),
    privateKey: localStorage.getItem('privateKey')
  };
}
function updateKeysUI() {
  const { publicKey, privateKey } = loadKeys();
  const el = document.getElementById('keys');
  if(publicKey && privateKey) {
    el.innerHTML = `<div><b>å…¬é–‹éµ</b><br><textarea rows="2">${publicKey}</textarea></div>
                    <div><b>ç§˜å¯†éµ</b><br><textarea rows="2">${privateKey}</textarea></div>`;
  } else {
    el.innerText = "éµãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚";
  }
}
document.getElementById('genBtn').onclick = function(){
  const key = ec.genKeyPair();
  const priv = key.getPrivate('hex');
  const pub = key.getPublic('hex');
  saveKeys(pub, priv);
  updateKeysUI();
  updateBalance(); loadAndDisplayChain(); // è¡¨ç¤ºæ›´æ–°
};
document.getElementById('resetBtn').onclick = function(){
  localStorage.removeItem('publicKey');
  localStorage.removeItem('privateKey');
  updateKeysUI();
  document.getElementById('balance').innerText = "æ®‹é«˜: -";
  document.getElementById('history').innerText = "";
};

/* --------- LocalStorage ãƒã‚§ãƒ¼ãƒ³é–¢ä¿‚ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --------- */

// ä¿å­˜ï¼ˆchainData ã¯ {length, chain} ã‹ã€chain array å˜ä½“ã§ã‚‚æ‰±ãˆã‚‹ï¼‰
function saveLocalChain(chainData) {
  // store as server-response-style object {length, chain}
  let obj;
  if(Array.isArray(chainData)) {
    obj = { length: chainData.length, chain: chainData };
  } else {
    obj = chainData;
  }
  try {
    localStorage.setItem(LS_CHAIN_KEY, JSON.stringify(obj));
    document.getElementById('chainStatus').innerText = `ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆlength=${obj.length})`;
  } catch(e) {
    console.error("saveLocalChain error", e);
    document.getElementById('chainStatus').innerText = "ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

// å–å¾—ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° nullï¼‰
function getLocalChainObj() {
  const s = localStorage.getItem(LS_CHAIN_KEY);
  if(!s) return null;
  try {
    return JSON.parse(s);
  } catch(e) {
    return null;
  }
}

/* --------- è¡¨ç¤ºç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --------- */
function displayChainObj(chainObj) {
  if(!chainObj || !Array.isArray(chainObj.chain)) {
    document.getElementById('history').innerText = "(ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒ¼ãƒ³ãªã—)";
    return;
  }
  const arr = chainObj.chain;
  let out = "";
  arr.forEach((block, idx) => {
    out += `Block #${idx}\n`;
    out += `Timestamp: ${new Date(block.timestamp*1000).toLocaleString()}\n`;
    out += `Hash: ${block.hash}\n`;
    out += `Prev: ${block.prev_hash}\n`;
    out += `Transactions:\n`;
    if(!block.transactions || block.transactions.length === 0) {
      out += "  (none)\n";
    } else {
      block.transactions.forEach(tx => {
        out += `  ${tx.sender} -> ${tx.recipient} : ${tx.amount}\n`;
      });
    }
    out += `\n-------------------------\n`;
  });
  document.getElementById('history').innerText = out;
}

/* --------- ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒã‚§ãƒ¼ãƒ³ã‚’å–ã£ã¦ãã¦æ¯”è¼ƒã™ã‚‹é–¢æ•° --------- */
/*
  æ¯”è¼ƒãƒ«ãƒ¼ãƒ«ï¼ˆç°¡æ˜“ï¼‰ï¼š
  - serverObj.length >= localLength ãªã‚‰ serverObj ã‚’æ¡ç”¨ã—ã¦ local ã«ä¿å­˜ãƒ»è¡¨ç¤ºï¼ˆã‚µãƒ¼ãƒãƒ¼ãŒåŒã˜ã‹é•·ã„ï¼‰
  - serverObj.length < localLength ãªã‚‰ local ã‚’ä¿æŒï¼ˆã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ãŒ"å…ˆè¡Œ"ã—ã¦ã„ã‚‹ï¼‰
  - ã©ã¡ã‚‰ã§ã‚‚ãªã„ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰ã¯ã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚§ãƒ¼ãƒ³ã‚’è¡¨ç¤ºï¼ˆå®‰å…¨å´ï¼‰
*/
async function fetchServerChainAndCompare(noteContext="manual") {
  document.getElementById('chainStatus').innerText = "ã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚§ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¦ã„ã¾ã™...";
  try {
    const res = await fetch('/chain');
    if(!res.ok) {
      document.getElementById('chainStatus').innerText = `ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒã‚§ãƒ¼ãƒ³å–å¾—å¤±æ•—: ${res.status}`;
      return null;
    }
    const serverObj = await res.json(); // {length, chain}
    const localObj = getLocalChainObj();
    const localLen = localObj && Array.isArray(localObj.chain) ? localObj.chain.length : 0;
    const serverLen = serverObj.length || (Array.isArray(serverObj.chain) ? serverObj.chain.length : 0);

    if(serverLen >= localLen) {
      // ã‚µãƒ¼ãƒãƒ¼ãŒåŒã˜é•·ã•ã‹é•·ã„ â†’ ã‚µãƒ¼ãƒãƒ¼ã‚’æ¡ç”¨ã—ã¦ä¿å­˜
      saveLocalChain(serverObj);
      displayChainObj(serverObj);
      document.getElementById('chainStatus').innerText = `ã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚§ãƒ¼ãƒ³ã‚’ä¿å­˜ãƒ»è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆserver ${serverLen} >= local ${localLen}ï¼‰`;
    } else {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ–¹ãŒé•·ã„ â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ç¶­æŒï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯çŸ­ã„ï¼‰
      displayChainObj(localObj);
      document.getElementById('chainStatus').innerText = `ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ç¶­æŒã—ã¾ã™ï¼ˆlocal ${localLen} > server ${serverLen}ï¼‰`;
    }
    return { serverObj, localObj };
  } catch (e) {
    console.error("fetchServerChainAndCompare error", e);
    document.getElementById('chainStatus').innerText = "ãƒã‚§ãƒ¼ãƒ³æ¯”è¼ƒä¸­ã«ã‚¨ãƒ©ãƒ¼";
    return null;
  }
}

/* --------- æ—¢å­˜ã®é–¢æ•°ï¼ˆé€é‡‘/æ®‹é«˜/è¡¨ç¤º/ãƒã‚¤ãƒ‹ãƒ³ã‚°ï¼‰ã‚’ localStorage ãƒ­ã‚¸ãƒƒã‚¯ã«çµ±åˆ --------- */

document.getElementById('txForm').onsubmit = async function(e){
  e.preventDefault();
  const { publicKey } = loadKeys();
  if(!publicKey) { alert("éµã‚’ç”Ÿæˆã—ã¦ãã ã•ã„"); return; }

  const recipient = e.target.recipient.value.trim();
  const amount = e.target.amount.value.trim();
  if(!recipient || !amount) { alert("æ­£ã—ã„å…¥åŠ›ã‚’ã—ã¦ãã ã•ã„"); return; }

  const payload = { sender: publicKey, recipient, amount };
  const res = await fetch('/transactions/new', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  document.getElementById('txResult').innerText = text;

  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ã£ãŸã‚‰ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚§ãƒ¼ãƒ³ã¨æ¯”è¼ƒã—ã¦ local ã‚’æ›´æ–°ã™ã‚‹ï¼ˆéåŒæœŸï¼‰
  setTimeout(()=>{ fetchServerChainAndCompare("after_tx"); }, 2000);
};

document.getElementById('balanceForm').onsubmit = async function(e){
  e.preventDefault();
  let address = e.target.address.value.trim();
  if(!address) address = loadKeys().publicKey;
  await updateBalance(address);
};

async function updateBalance(address){
  const addr = address || loadKeys().publicKey;
  if(!addr) { document.getElementById('balance').innerText = "æ®‹é«˜: -"; return; }
  try {
    const res = await fetch('/balance/' + addr);
    if(!res.ok) {
      document.getElementById('balance').innerText = "æ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼";
      return;
    }
    const j = await res.json();
    document.getElementById('balance').innerText = `æ®‹é«˜: ${j.balance}`;
  } catch(e) {
    document.getElementById('balance').innerText = "æ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼";
  }
}

/* "å±¥æ­´ã‚’è¡¨ç¤º" ãƒœã‚¿ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦æ¯”è¼ƒå‡¦ç†ã‚’å‘¼ã¶ */
document.getElementById('loadChainBtn').onclick = loadAndDisplayChain;
async function loadAndDisplayChain(){
  document.getElementById('chainStatus').innerText = "ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚µãƒ¼ãƒãƒ¼ã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™...";
  await fetchServerChainAndCompare("manual_load");
}

let mining = false;
document.getElementById('mineBtn').onclick = async function() {
  if (mining) return;

  const { publicKey } = loadKeys();
  if (!publicKey) { 
    alert("éµã‚’ç”Ÿæˆã—ã¦ãã ã•ã„"); 
    return; 
  }

  mining = true;
  const statusEl = document.getElementById('mineStatus');
  statusEl.innerText = "ãƒã‚¤ãƒ‹ãƒ³ã‚°ä¸­...";

  try {
    // ğŸ”¹ è¿½åŠ ï¼šãƒã‚¤ãƒ‹ãƒ³ã‚°å‰ã«å¿…ãš localStorage ã‹ã‚‰æœ€æ–°ã®ãƒã‚§ãƒ¼ãƒ³ã‚’èª­ã¿è¾¼ã‚€
    const savedChain = JSON.parse(localStorage.getItem('blockchain'));
    if (savedChain && savedChain.length > 0) {
      blockchain = savedChain;
    }

    // ã‚µãƒ¼ãƒãƒ¼ã«ãƒã‚¤ãƒ‹ãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
    const res = await fetch('/mine', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({miner: publicKey})
    });

    if (!res.ok) {
      statusEl.innerText = "Error: " + await res.text();
    } else {
      const j = await res.json();
      statusEl.innerText = `Block mined: ${j.block_hash} (miner: ${j.miner})`;

      // ğŸ”¹ ãƒã‚¤ãƒ‹ãƒ³ã‚°æˆåŠŸå¾Œã€æœ€æ–°ã®ãƒã‚§ãƒ¼ãƒ³ã‚’ localStorage ã«ä¿å­˜
      await loadChain(); // ã“ã‚Œã§ãƒ•ãƒ­ãƒ³ãƒˆã®è¡¨ç¤ºã‚‚æ›´æ–°ã•ã‚Œã‚‹
      localStorage.setItem('blockchain', JSON.stringify(blockchain));

      await updateBalance(j.miner);
    }
  } catch (err) {
    statusEl.innerText = "Error: " + err;
  } finally {
    mining = false;
    setTimeout(() => { document.getElementById('mineStatus').innerText = ""; }, 4000);
  }
};

document.getElementById('clearLocalChainBtn').onclick = () => {
    localStorage.removeItem('blockchain');
    alert("ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
};

/* Socket.IO: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ update ã‚’å—ã‘å–ã£ãŸã‚‰ã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚§ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¦æ¯”è¼ƒã—ã¦ä¿å­˜åˆ¤æ–­ */
socket.on('update', async (data) => {
  // data.type: 'transaction' or 'block'
  // ã“ã“ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚§ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¦ local ã¨æ¯”è¼ƒã™ã‚‹
  document.getElementById('chainStatus').innerText = "ã‚µãƒ¼ãƒãƒ¼é€šçŸ¥å—ä¿¡ã€ãƒã‚§ãƒ¼ãƒ³ã‚’å–å¾—ä¸­...";
  await fetchServerChainAndCompare("socket_update");
  // å¯èƒ½ã§ã‚ã‚Œã°æ®‹é«˜ã‚‚æ›´æ–°
  const pub = loadKeys().publicKey;
  if(pub) await updateBalance(pub);
});

/* ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®æŒ™å‹•ï¼š
   1) localStorage ã«ãƒã‚§ãƒ¼ãƒ³ãŒã‚ã‚Œã°è¡¨ç¤º
   2) ã™ãã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ /chain ã‚’å–ã‚Šã€é•·ã•ã‚’æ¯”è¼ƒã—ã¦ä¸Šæ›¸ã or ä¿æŒã™ã‚‹
*/
async function loadAndDisplayChainOnStart() {
  const localObj = getLocalChainObj();
  if(localObj) {
    displayChainObj(localObj);
    document.getElementById('chainStatus').innerText = `ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆlength=${localObj.length})`;
  } else {
    document.getElementById('chainStatus').innerText = "ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒ¼ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚";
  }
  // ç›´ã¡ã«ã‚µãƒ¼ãƒãƒ¼ã¨æ¯”è¼ƒã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä¸Šæ›¸ãã™ã‚‹ã‹æ±ºã‚ã‚‹
  await fetchServerChainAndCompare("startup");
}

/* åˆæœŸåŒ– */
updateKeysUI();
updateBalance();
loadAndDisplayChainOnStart();

/* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å®šæœŸçš„ã«ãƒã‚§ãƒ¼ãƒ³ã‚’ç¢ºèªï¼ˆ15ç§’æ¯ï¼‰ */
setInterval(()=>{ fetchServerChainAndCompare("polling"); }, 15000);
</script>
</body>
</html>
