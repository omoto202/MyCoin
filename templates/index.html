<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MyCoin P2P Wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.6.1/elliptic.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
body{font-family:Arial;padding:20px;background:#f5f5f5}
input{margin:5px 0;padding:5px;width:300px}
button{padding:6px 12px;margin-right:8px}
#result,#balance,#history,#keys,#mineResult{margin-top:20px}
textarea{width:100%;resize:none}
.block{background:#fff;padding:10px;border-radius:6px;margin-bottom:10px}
.mining { color: orange; font-weight: bold; }
.mined  { color: green; font-weight: bold; }
</style>
</head>
<body>
<h1>MyCoin P2P Wallet</h1>

<div class="block">
  <h2>éµç®¡ç†</h2>
  <button id="btnGen">éµãƒšã‚¢ç”Ÿæˆ</button>
  <button id="btnReset">éµãƒšã‚¢ãƒªã‚»ãƒƒãƒˆ</button>
  <div id="keys"></div>
</div>

<div class="block">
  <h2>ãƒˆãƒ¼ã‚¯ãƒ³é€ä¿¡</h2>
  <form id="txForm">
    <input name="recipient" placeholder="å—ä¿¡è€…ã‚¢ãƒ‰ãƒ¬ã‚¹(hex å…¬é–‹éµ)" required /><br />
    <input name="amount" type="number" step="0.01" placeholder="é‡‘é¡" required /><br />
    <button type="submit">é€ä¿¡</button>
  </form>
  <div id="result"></div>
</div>

<div class="block">
  <h2>æ®‹é«˜ç¢ºèª</h2>
  <form id="balanceForm">
    <input name="address" placeholder="ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ› (ç©ºã§è‡ªåˆ†ã®å…¬é–‹éµ)" />
    <button type="submit">æ®‹é«˜å–å¾—</button>
  </form>
  <div id="balance">æ®‹é«˜: -</div>
</div>

<div class="block">
  <h2>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³å…¨ä½“ã®å±¥æ­´</h2>
  <button id="loadChain">å…¨å±¥æ­´ã‚’è¡¨ç¤º</button>
  <div id="history" style="margin-top:10px;white-space:pre-wrap;background:#fafafa;padding:10px;border-radius:6px"></div>
</div>

<div class="block">
  <h2>ãƒã‚¤ãƒ‹ãƒ³ã‚°</h2>
  <button id="mineBtn">ãƒã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹</button>
  <span id="mineResult"></span>
</div>

<script>
const EC = elliptic.ec;
const ec = new EC('secp256k1');
const socket = io();

// UI elements
const keysDiv = document.getElementById('keys');
const resultDiv = document.getElementById('result');
const balanceDiv = document.getElementById('balance');
const historyDiv = document.getElementById('history');
const mineResultSpan = document.getElementById('mineResult');

document.getElementById('btnGen').onclick = generateKeys;
document.getElementById('btnReset').onclick = resetKeys;
document.getElementById('loadChain').onclick = loadChain;
document.getElementById('mineBtn').onclick = mine;

function saveKeys(pub, priv){
  localStorage.setItem('publicKey', pub);
  localStorage.setItem('privateKey', priv);
}

function loadKeys(){
  return {
    publicKey: localStorage.getItem('publicKey'),
    privateKey: localStorage.getItem('privateKey')
  };
}

function updateKeysUI(){
  const {publicKey, privateKey} = loadKeys();
  if(publicKey && privateKey){
    keysDiv.innerHTML = `<b>å…¬é–‹éµ:</b><br><textarea rows="2">${publicKey}</textarea>
    <b>ç§˜å¯†éµ:</b><br><textarea rows="2">${privateKey}</textarea>`;
  } else {
    keysDiv.innerHTML = "<i>éµãƒšã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚</i>";
  }
}

function generateKeys(){
  const key = ec.genKeyPair();
  const priv = key.getPrivate('hex');
  const pub = key.getPublic('hex'); // 04 + x + y (hex)
  saveKeys(pub, priv);
  updateKeysUI();
  updateBalance();
  loadChain();
  alert("éµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚å…¬é–‹éµã‚’ç›¸æ‰‹ã«æ¸¡ã™ã¨é€é‡‘ã§ãã¾ã™ã€‚");
}

function resetKeys(){
  localStorage.removeItem('publicKey');
  localStorage.removeItem('privateKey');
  updateKeysUI();
  balanceDiv.innerText = "æ®‹é«˜: -";
  historyDiv.innerHTML = "";
}

async function updateBalance(address){
  let addr = address;
  if(!addr) addr = localStorage.getItem('publicKey');
  if(!addr){ balanceDiv.innerText = "æ®‹é«˜: -"; return; }
  const res = await fetch('/balance/' + addr);
  const json = await res.json();
  balanceDiv.innerText = `æ®‹é«˜: ${json.balance}`;
}

async function loadChain(){
  const res = await fetch('/chain');
  const json = await res.json();
  let out = "";
  json.chain.forEach((block, idx) => {
    out += `ğŸ§± ãƒ–ãƒ­ãƒƒã‚¯ #${idx}\n`;
    out += `Timestamp: ${new Date(block.timestamp * 1000).toLocaleString()}\n`;
    out += `Hash: ${block.hash}\n`;
    out += `Prev: ${block.prev_hash}\n`;
    out += `Transactions:\n`;
    if(!block.transactions || block.transactions.length === 0){
      out += "  ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ï¼‰\n";
    } else {
      block.transactions.forEach(tx => {
        out += `  ${tx.sender} -> ${tx.recipient} : ${tx.amount}`;
        if(tx.signature) out += ` (sig:${tx.signature.slice(0,20)}...)`;
        out += `\n`;
      });
    }
    out += `\n--------------------------------------\n`;
  });
  historyDiv.innerText = out;
}

// ---------------------
// é€é‡‘ï¼ˆç½²åä»˜ãï¼‰
// ---------------------
document.getElementById('txForm').onsubmit = async function(e){
  e.preventDefault();
  const {privateKey, publicKey} = loadKeys();
  if(!privateKey || !publicKey){
    alert("ã¾ãšéµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const recipient = e.target.recipient.value.trim();
  const amount = parseFloat(e.target.amount.value);
  if(!recipient || !amount) { alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  // åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼å´ã¨åˆã‚ã›ã‚‹
  const message = `${publicKey}->${recipient}:${Number(amount).toFixed(8)}`;
  const key = ec.keyFromPrivate(privateKey, 'hex');
  const signature = key.sign(message).toDER('hex');
  
  const payload = {
    sender: publicKey,
    recipient,
    amount,
    signature
  };

  const res = await fetch('/transactions/new', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  resultDiv.innerText = text;
};

// ---------------------
// æ®‹é«˜ãƒ•ã‚©ãƒ¼ãƒ 
// ---------------------
document.getElementById('balanceForm').onsubmit = async function(e){
  e.preventDefault();
  const address = e.target.address.value.trim();
  await updateBalance(address);
};

// ---------------------
// ãƒã‚¤ãƒ‹ãƒ³ã‚°ï¼ˆå³æ™‚ãƒ–ãƒ­ãƒƒã‚¯ã«å ±é…¬ã‚’å…¥ã‚Œã‚‹ï¼‰
// ---------------------
let mining = false;
async function mine(){
  if(mining) return;
  const {publicKey} = loadKeys();
  if(!publicKey){
    alert("ã¾ãšéµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // UI è¡¨ç¤ºï¼šãƒã‚¤ãƒ‹ãƒ³ã‚°ä¸­
  mining = true;
  const btn = document.getElementById('mineBtn');
  btn.disabled = true;
  mineResultSpan.className = 'mining';
  mineResultSpan.innerText = 'Mining...';

  try {
    const res = await fetch('/mine', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ miner: publicKey })
    });
    if(!res.ok){
      const txt = await res.text();
      mineResultSpan.className = '';
      mineResultSpan.innerText = 'Error: ' + txt;
    } else {
      const j = await res.json();
      mineResultSpan.className = 'mined';
      mineResultSpan.innerText = `Block mined (${j.block_hash}) â€” reward -> ${j.miner}`;
      // å³æ™‚æ®‹é«˜æ›´æ–°ã¨å±¥æ­´æ›´æ–°
      await updateBalance(publicKey);
      await loadChain();
    }
  } catch(err){
    mineResultSpan.className = '';
    mineResultSpan.innerText = 'Error: ' + err;
  } finally {
    mining = false;
    btn.disabled = false;
    // 3ç§’å¾Œã«è‰²ã‚’æˆ»ã™ï¼ˆä»»æ„ï¼‰
    setTimeout(()=>{ mineResultSpan.className = ''; }, 3000);
  }
}

// ---------------------
// Socket.IO ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
// ---------------------
socket.on('connect', ()=>console.log('Socket connected'));
socket.on('disconnect', ()=>console.log('Socket disconnected'));

// ã‚µãƒ¼ãƒãƒ¼ãŒ 'update' ã‚’ emit ã™ã‚‹ã®ã§å—ã‘å–ã‚‹
socket.on('update', async (data) => {
  // data.type ã¯ 'transaction' ã‹ 'block'
  console.log('update received', data);
  // å±¥æ­´ãƒ»æ®‹é«˜ã‚’è‡ªå‹•æ›´æ–°ï¼ˆè‡ªåˆ†ã®å…¬é–‹éµã‚’å‚ç…§ï¼‰
  const pub = localStorage.getItem('publicKey');
  if(pub) {
    await updateBalance(pub);
  } else {
    await updateBalance();
  }
  await loadChain();
});

// èµ·å‹•æ™‚
updateKeysUI();
updateBalance();
loadChain();

// è‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆå¿µã®ãŸã‚ã€Socket ãŒå±Šã‚ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
setInterval(async ()=>{ await loadChain(); }, 15000);
</script>
</body>
</html>
