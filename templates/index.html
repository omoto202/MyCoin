<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MyCoin Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/elliptic@6.5.5/dist/elliptic.min.js"></script>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background-color: #f5f5f5; }
    input { margin: 5px 0; padding: 5px; width: 300px; }
    button { padding: 5px 10px; margin-top: 5px; }
    #result, #balance, #mineResult { margin-top: 20px; }
    #history { margin-top: 20px; background: white; padding: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>MyCoin Wallet</h1>

  <h2>鍵ペア生成</h2>
  <button onclick="generateKeys()">鍵ペア生成</button>
  <div id="keys"></div>

  <hr>

  <h2>コイン送信</h2>
  <form id="txForm">
    <input name="recipient" placeholder="受信者の公開鍵" required /><br>
    <input name="amount" type="number" step="0.01" placeholder="金額" required /><br>
    <button type="submit">送信</button>
  </form>
  <div id="result"></div>

  <hr>

  <h2>残高確認</h2>
  <button onclick="checkBalance()">残高を取得</button>
  <div id="balance"></div>

  <hr>

  <h2>マイニング</h2>
  <button onclick="mine()">マイニング開始</button>
  <div id="mineResult"></div>

  <hr>

  <h2>ブロックチェーン履歴</h2>
  <div id="history"></div>

  <script>
    const ec = new elliptic.ec("secp256k1");
    const socket = io();

    function generateKeys() {
      const key = ec.genKeyPair();
      const privateKey = key.getPrivate("hex");
      const publicKey = key.getPublic("hex");
      localStorage.setItem("privateKey", privateKey);
      localStorage.setItem("publicKey", publicKey);
      document.getElementById("keys").innerText =
        `公開鍵: ${publicKey.slice(0, 40)}...\n秘密鍵: ${privateKey.slice(0, 40)}...`;
    }

    async function checkBalance() {
      const address = localStorage.getItem("publicKey");
      if (!address) return alert("鍵ペアを生成してください。");
      const res = await fetch("/balance/" + address);
      const json = await res.json();
      document.getElementById("balance").innerText =
        `残高: ${json.balance} MyC`;
    }

    document.getElementById("txForm").onsubmit = async e => {
      e.preventDefault();
      const recipient = e.target.recipient.value;
      const amount = parseFloat(e.target.amount.value);
      const privateKey = localStorage.getItem("privateKey");
      const publicKey = localStorage.getItem("publicKey");
      if (!privateKey || !publicKey) return alert("鍵ペアを生成してください。");

      const txData = JSON.stringify({ sender: publicKey, recipient, amount });
      const hash = CryptoJS.SHA256(txData).toString();
      const key = ec.keyFromPrivate(privateKey);
      const signature = key.sign(hash).toDER();
      const sigBase64 = btoa(String.fromCharCode(...signature));

      const res = await fetch("/transactions/new", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sender: publicKey,
          recipient,
          amount,
          signature: sigBase64
        })
      });
      const text = await res.text();
      document.getElementById("result").innerText = text;
    };

    async function mine() {
      const publicKey = localStorage.getItem("publicKey");
      if (!publicKey) return alert("鍵ペアを生成してください。");

      const mineResult = document.getElementById("mineResult");
      mineResult.innerText = "⛏️ マイニング中...";

      const res = await fetch("/mine", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ miner: publicKey })
      });

      const json = await res.json();
      mineResult.innerText = "✅ Block mined!\n残高: " + json.balance + " MyC";
      loadChain();
      checkBalance();
    }

    async function loadChain() {
      const res = await fetch("/chain");
      const json = await res.json();
      const div = document.getElementById("history");
      div.innerHTML = "";
      json.chain.forEach(block => {
        const b = document.createElement("div");
        b.innerHTML = `<b>Block:</b> ${block.hash.slice(0, 20)}...<br>
          <b>Tx:</b> ${block.transactions.length}<br><hr>`;
        div.appendChild(b);
      });
    }

    // 初期ロード
    loadChain();
    checkBalance();

    // リアルタイム更新
    socket.on("new_block", () => {
      loadChain();
      checkBalance();
    });
    socket.on("new_transaction", () => {
      loadChain();
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</body>
</html>
