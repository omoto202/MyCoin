<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyCoin Wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.6.1/elliptic.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
input { padding: 6px; margin: 6px 0; width: 320px; }
button { padding: 6px 10px; margin: 4px; }
textarea { width: 100%; }
.block { background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
#history { white-space: pre-wrap; background:#f9f9f9; padding:8px; border-radius:4px; }
</style>
</head>
<body>
<h1>MyCoin Wallet</h1>

<div class="block">
  <h2>鍵管理</h2>
  <button id="genBtn">鍵ペア生成</button>
  <button id="resetBtn">鍵ペアリセット</button>
  <div id="keys">鍵がありません。</div>
</div>

<div class="block">
  <h2>送金</h2>
  <form id="txForm">
    <input name="recipient" placeholder="受信者の公開鍵" required><br>
    <input name="amount" placeholder="金額" required><br>
    <button type="submit">送信</button>
  </form>
  <div id="txResult"></div>
</div>

<div class="block">
  <h2>残高確認</h2>
  <form id="balanceForm">
    <input name="address" placeholder="アドレスを入力（空で自分の公開鍵）"><br>
    <button type="submit">残高取得</button>
  </form>
  <div id="balance">残高: -</div>
</div>

<div class="block">
  <h2>ブロックチェーン</h2>
  <button id="loadChainBtn">履歴を表示</button>
  <div id="history"></div>
</div>

<div class="block">
  <h2>マイニング</h2>
  <button id="mineBtn">マイニング開始</button>
  <div id="mineStatus"></div>
</div>

<script>
const ec = new elliptic.ec('secp256k1');
const socket = io();

function saveKeys(pub, priv) {
  localStorage.setItem('publicKey', pub);
  localStorage.setItem('privateKey', priv);
}
function loadKeys() {
  return {
    publicKey: localStorage.getItem('publicKey'),
    privateKey: localStorage.getItem('privateKey')
  };
}
function updateKeysUI() {
  const { publicKey, privateKey } = loadKeys();
  const el = document.getElementById('keys');
  if(publicKey && privateKey) {
    el.innerHTML = `<div><b>公開鍵</b><br><textarea rows="2">${publicKey}</textarea></div>
                    <div><b>秘密鍵</b><br><textarea rows="2">${privateKey}</textarea></div>`;
  } else {
    el.innerText = "鍵がありません。生成してください。";
  }
}

document.getElementById('genBtn').onclick = function(){
  const key = ec.genKeyPair();
  const priv = key.getPrivate('hex');
  const pub = key.getPublic('hex');
  saveKeys(pub, priv);
  updateKeysUI();
  updateBalance(); loadChain();
};

document.getElementById('resetBtn').onclick = function(){
  localStorage.removeItem('publicKey');
  localStorage.removeItem('privateKey');
  updateKeysUI();
  document.getElementById('balance').innerText = "残高: -";
  document.getElementById('history').innerText = "";
};

document.getElementById('txForm').onsubmit = async function(e){
  e.preventDefault();
  const { publicKey } = loadKeys();
  if(!publicKey) { alert("鍵を生成してください"); return; }

  const recipient = e.target.recipient.value.trim();
  const amount = e.target.amount.value.trim();
  if(!recipient || !amount) { alert("正しい入力をしてください"); return; }

  const payload = { sender: publicKey, recipient, amount };
  const res = await fetch('/transactions/new', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  document.getElementById('txResult').innerText = text;
};

document.getElementById('balanceForm').onsubmit = async function(e){
  e.preventDefault();
  let address = e.target.address.value.trim();
  if(!address) address = loadKeys().publicKey;
  await updateBalance(address);
};

async function updateBalance(address){
  const addr = address || loadKeys().publicKey;
  if(!addr) { document.getElementById('balance').innerText = "残高: -"; return; }
  const res = await fetch('/balance/' + addr);
  const j = await res.json();
  document.getElementById('balance').innerText = `残高: ${j.balance}`;
}

document.getElementById('loadChainBtn').onclick = loadChain;
async function loadChain(){
  const res = await fetch('/chain');
  const j = await res.json();
  let out = "";
  j.chain.forEach((block, idx)=>{
    out += `Block #${idx}\nTimestamp: ${new Date(block.timestamp*1000).toLocaleString()}\nHash: ${block.hash}\nPrev: ${block.prev_hash}\nTransactions:\n`;
    if(!block.transactions || block.transactions.length===0) out += "  (none)\n";
    else block.transactions.forEach(tx=>{
      out += `  ${tx.sender} -> ${tx.recipient} : ${tx.amount}\n`;
    });
    out += "\n-------------------------\n";
  });
  document.getElementById('history').innerText = out;
}

let mining=false;
document.getElementById('mineBtn').onclick = async function(){
  if(mining) return;
  const { publicKey } = loadKeys();
  if(!publicKey) { alert("鍵を生成してください"); return; }

  mining = true;
  const statusEl = document.getElementById('mineStatus');
  statusEl.innerText = "マイニング中...";

  try {
    const res = await fetch('/mine', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({miner: publicKey})
    });
    if(!res.ok){
      statusEl.innerText = "Error: "+await res.text();
    } else {
      const j = await res.json();
      statusEl.innerText = `Block mined: ${j.block_hash} (miner: ${j.miner})`;
      await updateBalance(j.miner);
      await loadChain();
    }
  } catch(err){
    statusEl.innerText = "Error: "+err;
  } finally {
    mining=false;
    setTimeout(()=>{ document.getElementById('mineStatus').innerText=""; }, 4000);
  }
};

socket.on('update', async data=>{
  const pub = loadKeys().publicKey;
  if(pub) await updateBalance(pub);
  else await updateBalance();
  await loadChain();
});

updateKeysUI(); updateBalance(); loadChain();
setInterval(()=>{ loadChain(); }, 15000);
</script>
</body>
</html>
